# Earth4AllSA
Code associated to the paper *Making the Word Better with Fewer Turnarounds. A sensitivity analysis of the Earth for All model* and based on the Julia implementation of the [Earth4All model](https://earth4all.life/the-science-rp/) using the [WorldDynamics framework](https://github.com/worlddynamics/WorldDynamics.jl) and referring to the [April 2023 Vensim version](https://web.archive.org/web/20220830093115/https://earth4all.life/the-science/) available [here](https://stockholmuniversity.app.box.com/s/uh7fjh52pvh7yx1mqfwqcyxdcvegrodf/folder/170558692760). A list of the variables, equations and parameters of this implementation is available [here](https://www.pilucrescenzi.it/e4asa/e4a.html).

## How to run the code

### Prerequisites

[Install Julia](https://julialang.org/) and clone the repository: 
```sh
git clone https://github.com/piluc/Earth4AllSA
```

### Setting up the environment

After starting the Julia REPL in the repository folder, the environment is instantiated by running
```jl
using Pkg;
Pkg.activate(".");
Pkg.instantiate();
```

The sensitivity analysis code, which also loads the `Earth4All` module, is then included by running
```jl
include("src/E4ASA.jl");
```

### Reproducing the TLTL scenario and the GL scenario

The two scenarios can be reproduced by running
```jl
e4a, _, prob = e4a_sys_prob();
tltl = compute_tltl_sol(prob);
gl = compute_gl_sol(prob);
```
The final values of the six indicators in the two scenarios can be retrieved by running
```jl
tltl[e4a.AWBI][end]
gl[e4a.AWBI][end]
tltl[e4a.GDPP][end]
gl[e4a.GDPP][end]
tltl[e4a.INEQ][end]
gl[e4a.INEQ][end]
tltl[e4a.OW][end]
gl[e4a.OW][end]
tltl[e4a.POP][end]
gl[e4a.POP][end]
tltl[e4a.STE][end]
gl[e4a.STE][end]
```
These values are the ones reported in the table of Fig. 1 of the paper. The figure itself can be reproduced by running

```jl
plot_two_sol_var(e4a, "TLTL", tltl, "GL", gl, collect(1:6), "", false, true)
```
(actually the result is an interactive version of Fig. 1). One can also plot one scenario only by running, for example,
```jl
plot_sol_var(e4a, tltl, collect(1:6), "The TLTL scenario", false, true)
```

### Reproducing the GL18 scenario

This scenario can be reproduced by running
```jl
gl18 = compute_gl18_sol(prob);
```
The MRE shown in Table 1 can be computed by running

```jl
compare(gl[e4a.AWBI], gl18[e4a.AWBI],1)
compare(gl[e4a.GDPP], gl18[e4a.GDPP],1)
compare(gl[e4a.INEQ], gl18[e4a.INEQ],1)
compare(gl[e4a.OW], gl18[e4a.OW],1)
compare(gl[e4a.POP], gl18[e4a.POP],1)
compare(gl[e4a.STE], gl18[e4a.STE],1)
```

### Executing the Sobol senisitivity analysis

To compute the Sobol indices, the corresponding Julia code has to be included by running
```jl
include("src/sobolsensitivity.jl");
```
The computation can then be done by running
```jl
res = execute_sobol(10);
```
Note that the execution time of the Sobol analysis can be quite high and it depends on the number of samples to be used (in the above code is 10). For this reason, in the `sobol` directory the result obtained by running the code with 10000 samples is available and it can be loaded by running
```jl
res = retrieve_sobol("sobol/sobol10000.dat");
```
All the bar plots included in the paper can then be reproduced by running
```jl
sobol_bar_plots(res);
```
The execution of the above code will create a directory `sobol/plots` containing, for each indicator, two HTML and two PNG files showing the bar plots of the Sobol indices with respect to indicator (averaged over 6 and 12 years, respectively). All plots use the acronym of each parameter, instead of its full name.

### Executing the local senisitivity analysis

The tornado diagrams included in the paper can be obtained by running
```jl
td_awbi = tornado_diagram(e4a, prob, gl, e4a.AWBI, 120);
td_gdpp = tornado_diagram(e4a, prob, gl, e4a.GDPP, 120);
td_ineq = tornado_diagram(e4a, prob, gl, e4a.INEQ, 120);
td_ow = tornado_diagram(e4a, prob, gl, e4a.OW, 120);
td_pop = tornado_diagram(e4a, prob, gl, e4a.POP, 120);
td_ste = tornado_diagram(e4a, prob, gl, e4a.STE, 120);
```
For example, the first nine elements of `td_awbi` are
```
(8, ETGBW, 20.599999999999998, -20.9)
(22, MIROTA2022, -20.1, 16.3)
(3, DACCO22100, -10.6, 10.9)
(9, GEIC, -7.5, 7.6)
(5, EETF2022, -6.2, 6.2)
(7, EPTF2022, -6.2, 6.2)
(20, USPUS2022, -5.5, 5.3)
(11, GFCO2SCCS, -9.3, 1.3)
(19, USPIS2022, -4.6, 4.5)
```
which correspond to the first nine lines of the tornado diagram shown in Fig. 5 (once again each parameter is referenced by its acronym, instead of its full name).

The spider diagram shown in Fig. 6, instead, can be generated by running
```jl
perc = local_sensitivity_gl(e4a, prob, gl);
spider_plot(perc, e4a, 1, [8,22,3,9,5,7,20,11,19], false, true, false)
```
(note that 1 is the index of the variable `e4a.AWBI` and `[8,22,3,9,5,7,20,11,19]` are the indices of the first nine parameters in the tornado diagram correspondign to this variable). The other spider diagrams can be generated by running a similar code for each of the remaining five variables.

### Reproducing the other scenarios

The remining scenarios analysed in the paper can be generated by running
```jl
gl6 = compute_alpha_sol(prob, [], [1.0,1.0,1.0,1.0,1.0,1.0], [3,9,11,19,20,22]);
dgl6 = compute_alpha_sol(prob, [], [2.0,2.0,2.0,2.0,2.0,2.0], [3,9,11,19,20,22]);
gl4 = compute_alpha_sol(prob, [], [0.25,2.0,0.5,2.0,2.0,2.0], [3,9,11,19,20,22]);
a = fill(1.0, 22); a[3] = 0.25; a[11] = 0.5; mgl = compute_alpha_sol(prob, [], a, collect(1:22));
```
Figs. 7-9 can then be produced similarly to what has been done in the case of the comparison of the TLTL scenario and the GL scenario. 

